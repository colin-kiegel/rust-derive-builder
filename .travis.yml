sudo: false
language: rust
rust:
  - beta
  - stable
  - 1.15.0
matrix:
  include:
    - rust: nightly
      env: JOB=build CARGO_FEATURES="dev_nightly"
    - rust: nightly
      env: JOB=style_check CARGO_FEATURES="dev_nightly"
  allow_failures:
    - env: JOB=style_check
  fast_finish: true
env:
  matrix:
    - JOB=build
  global:
  - CARGO_FEATURES=""
  - RUST_BACKTRACE=1
  - TRAVIS_CARGO_NIGHTLY_FEATURE=""
  - PKGNAME=derive_builder
  # encrypted github token for doc+coveralls upload
  - secure: "oGshXdNEX+SK3O6cwGsMN9TGjfAtXXDFxBa5Ti38m8cNR2DdYikV5BMgsPQdWj8K58m2H3hiU3jWGI1d3W94ELlKXRcAJg39x10TPAHd+L89zSk48JorZejgKVARJuW3qDAO/xbi+bc0/Q1sgq9h7zBxAWfD7PJ3Lu/k20SRmoghDC+ufHr6bElkAZM388WD1q8eZgITBQWXDBYy8id85TxxagK0Xq/ZjDhCNwcz9A9rO8QrX886nAr8liL54M+XZ35+wwiw+5s3Vz5Oa/sKnVg33VKIjDwOs3YZP4+egFFEtEVVlvAm+NmzWIYzOi8VJbNmV00c3qhSRkEwCOGR41m4Nl/bmhMu6iL9epvqdaouElkg74dV6qqeYq/jGOJrklHuUmyPvXbTYukpNt6a9nqDu8IPrLkQOjpKnKQtmazdOyajiqwUiv6/GXb6tarSzMzsXqM+l/wWplFZkwaDvWR9m5OgilohpFYdhrbJNUd1zffgfwvYFBNVXnkRScwrVBpVfAz420w2s/YfONfl/DtrHt1U/O+gDQ92AGc6foOqCJoqup6uasWkgRbPMGm5hl6n7JALGYjNB60BLi7okItITosoprknXUfLoPzrpnMRi9ScEjEXUBliKxBXnPyMKAZur39PfKGeIasOPwQIPo9xhpWTsOUcuux9l4eihX0="
addons:
  apt:
    packages:
    # travis-cargo dependencies
    - libcurl4-openssl-dev
    - libelf-dev
    - libdw-dev
before_script: |
  # load travis cargo
  # - https://github.com/huonw/travis-cargo
  pip install 'travis-cargo<0.2' --user &&
  export PATH="$HOME/.local/bin:$HOME/.cargo/bin:$PATH"
  # share build artifacts:
  export CARGO_TARGET_DIR="$TRAVIS_BUILD_DIR"
  if [ "$JOB" = "style_check" ]; then
    which cargo-clippy || cargo install clippy --debug || exit
    which cargo-fmt || cargo install rustfmt --debug || exit
  fi
script: |
  //////////////////////////////////////////////////////////////////////////////
  // populate `${commands[@]}` and `${crates[@]}` according to `$JOB`.
  //////////////////////////////////////////////////////////////////////////////

  crates=(
    derive_builder_core
    derive_builder
    derive_builder_test
  )
  case "$JOB" in
    build)
      commands=(
        "travis-cargo build -- --features \"\$CARGO_FEATURES\""
        "travis-cargo test -- --no-fail-fast --features \"\$CARGO_FEATURES\""
        "travis-cargo doc"
      )
      ;;
    style_check)
      commands=(
        "cargo clippy -- -Dclippy"
        "cargo fmt -- --write-mode diff"
      )
      ;;
    *)
      exit 1
      ;;
  esac

  //////////////////////////////////////////////////////////////////////////////
  // run all `${commands[@]}` for all `${crates[@]}` and exit.
  //////////////////////////////////////////////////////////////////////////////

  exit=0; // store `$?` https://github.com/travis-ci/travis-ci/issues/3771
  OK_COLOR='\033[0;32m' # green
  ERR_COLOR='\033[0;31m' # red
  NO_COLOR='\033[0m' # reset

  for cmd in ${commands[@]}; do
    for crate in ${crates[@]}; do
      echo "running `$cmd` for crate `$crate`."

      (cd $crate && $cmd); ret_code=$?

      if [ $ret_code -eq 0 ]; then
        color="$OK_COLOR"
      else
        color="$ERR_COLOR"
        exit=$ret_code
      fi
      echo -e "${color}The command `${cmd}` exited with ${ret_code}.${NO_COLOR}"
    done
  done
  (exit $EXIT)
after_success: |
  # upload the documentation from the build with stable (automatically only
  # runs on the master branch, not individual PRs)
  travis-cargo --only stable doc-upload -- --features "$CARGO_FEATURES"
