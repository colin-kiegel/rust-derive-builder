sudo: false
language: rust
rust:
  - beta
  - stable
  - 1.15.0
matrix:
  include:
    - rust: nightly
      env: JOB=build CARGO_FEATURES="dev_nightly"
    - rust: nightly
      env: JOB=style_check CARGO_FEATURES="dev_nightly"
  allow_failures:
    - env: JOB=style_check
  fast_finish: true
env:
  matrix:
    - JOB=build
  global:
  - CARGO_FEATURES=""
  - RUST_BACKTRACE=1
  - TRAVIS_CARGO_NIGHTLY_FEATURE=""
  - PKGNAME=derive_builder
  - LOCAL="~/.local"
  # encrypted github token for doc+coveralls upload
  - secure: "oGshXdNEX+SK3O6cwGsMN9TGjfAtXXDFxBa5Ti38m8cNR2DdYikV5BMgsPQdWj8K58m2H3hiU3jWGI1d3W94ELlKXRcAJg39x10TPAHd+L89zSk48JorZejgKVARJuW3qDAO/xbi+bc0/Q1sgq9h7zBxAWfD7PJ3Lu/k20SRmoghDC+ufHr6bElkAZM388WD1q8eZgITBQWXDBYy8id85TxxagK0Xq/ZjDhCNwcz9A9rO8QrX886nAr8liL54M+XZ35+wwiw+5s3Vz5Oa/sKnVg33VKIjDwOs3YZP4+egFFEtEVVlvAm+NmzWIYzOi8VJbNmV00c3qhSRkEwCOGR41m4Nl/bmhMu6iL9epvqdaouElkg74dV6qqeYq/jGOJrklHuUmyPvXbTYukpNt6a9nqDu8IPrLkQOjpKnKQtmazdOyajiqwUiv6/GXb6tarSzMzsXqM+l/wWplFZkwaDvWR9m5OgilohpFYdhrbJNUd1zffgfwvYFBNVXnkRScwrVBpVfAz420w2s/YfONfl/DtrHt1U/O+gDQ92AGc6foOqCJoqup6uasWkgRbPMGm5hl6n7JALGYjNB60BLi7okItITosoprknXUfLoPzrpnMRi9ScEjEXUBliKxBXnPyMKAZur39PfKGeIasOPwQIPo9xhpWTsOUcuux9l4eihX0="
addons:
  apt:
    packages:
    # travis-cargo dependencies
    - libcurl4-openssl-dev
    - libelf-dev
    - libdw-dev
before_script: |
  # load travis cargo
  # - https://github.com/huonw/travis-cargo
  pip install 'travis-cargo<0.2' --user &&
  export PATH="$LOCAL/bin:$PATH"
  # share build artifacts:
  export CARGO_TARGET_DIR="$TRAVIS_BUILD_DIR"
  if [ "$JOB" = "style_check" ]; then
    cargo install clippy --debug --force || exit
    cargo install rustfmt --debug --force || exit
  fi
script: |
  case "$JOB" in
    build)
      # cargo build and cargo doc do not support `--all` in rustc 1.15,
      # but `-p derive_builder_test` will implicitly build/doc `derive_builder`
      # and `derive_builder_core` too.
      (cd $TRAVIS_BUILD_DIR/derive_builder &&
      travis-cargo build -- -p derive_builder_test --features "$CARGO_FEATURES" &&
      travis-cargo test -- --all --no-fail-fast --features "$CARGO_FEATURES" &&
      travis-cargo doc -- -p derive_builder_test)
      ;;
    style_check)
      for crate in derive_builder derive_builder_core derive_builder_test; do
        (cd $TRAVIS_BUILD_DIR/$crate &&
        cargo clippy -- -Dclippy &&
        cargo fmt -- --write-mode diff) || exit
      done
      ;;
    *)
      exit 1
      ;;
  esac
after_success: |
  # upload the documentation from the build with stable (automatically only
  # runs on the master branch, not individual PRs)
  travis-cargo --only stable doc-upload -- --features "$CARGO_FEATURES"
